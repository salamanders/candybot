<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA/4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAERERERERERERAAAAAAAAERAQAAAAAAEBEAEAAAAAEAEQABAAAAEAARAAAQAAEAABEAAAEAEAAAEQAAABEAAAARAAAAEQAAABEAAAEAEAAAEQAAEAABAAARAAEAAAAQABEAEAAAAAEAEQEAAAAAABAREAAAAAAAAREREREREREREAAAAAP/wAAF/6AABv9gAAd+4AAHveAAB9vgAAfn4AAH5+AAB9vgAAe94AAHfuAABv9gAAX/oAAD/8AAAAAAAA"
          rel="icon" type="image/x-icon"/>
    <title>Make Magic</title>
    <link href="./css/reset.css" media="all" rel="stylesheet"/>
    <style>
        html, body {
            margin: 0; /* Make sure that there is no margin around the canvas */
            overflow: hidden; /* Make sure we don't get scroll bars. */
            background-color: black;
        }
    </style>

    <script type="module">
        import {blockUntilDOMReady} from "./modules/polyfill.mjs";
        import * as STAGE from "./modules/simple-stage.mjs";
        import * as WEBCAM from "./modules/simple-webcam.mjs";
        import * as POSE from "./modules/simple-pose.mjs";
        import * as PARTICLES from "./modules/particles.mjs";

        await blockUntilDOMReady();
        await WEBCAM.setup();
        STAGE.setup(WEBCAM.video);
        await POSE.setup();

        /**
         * Always have a loop
         * @param {DOMHighResTimeStamp} ts
         */
        async function frameUpdates(ts) {

            const keypoints = await POSE.estimatePoses(WEBCAM.video);
            if (keypoints && keypoints.length > 0) {
                // console.log(JSON.stringify(currentPose));
                const leftWrist = keypoints.find(keypoint => keypoint.name === 'left_wrist');
                const rightWrist = keypoints.find(keypoint => keypoint.name === 'right_wrist');
                const anyWrist = leftWrist ?? rightWrist;
                if (anyWrist) {
                    console.log(`Wrist:`, anyWrist);
                    PARTICLES.spawn(anyWrist.x, anyWrist.y);
                }
            }

            // STAGE.ctx.drawImage(WEBCAM.video, 0, 0);
            PARTICLES.moveAndDraw(STAGE.ctx);
            requestAnimationFrame(frameUpdates);
        }

        console.info(`Kicking off the animation loop.`);
        requestAnimationFrame(frameUpdates);
    </script>
</head>
<body>
</body>
</html>